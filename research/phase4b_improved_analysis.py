#!/usr/bin/env python3
"""
Phase 4-B: Í∞úÏÑ†Îêú ÎåÄÍ∑úÎ™® Î∂ÑÏÑù - 100K ÏÉòÌîå
==========================================

Phase 4-A Î¨∏Ï†úÏ†ê Ìï¥Í≤∞:
1. ‚úÖ ÏïºÍ∞Ñ ÌîåÎûòÍ∑∏ Î≤ÑÍ∑∏ ÏàòÏ†ï
2. ‚úÖ Îß§Ïπ≠ Í∏∞Ï§Ä ÏôÑÌôî (Í±∞Î¶¨ 200km, ÏãúÍ∞Ñ ¬±7Ïùº)
3. ‚úÖ ÏÉòÌîå Í∑úÎ™® 10Î∞∞ ÌôïÎåÄ
4. ‚úÖ ÌÜµÍ≥ÑÏ†Å Î∂ÑÏÑù Í∞ïÌôî

Î™©Ìëú:
- US Accidents: 100,000Í∞ú
- Vehicle Sensor: 10,000Í∞ú  
- Î™©Ìëú Îß§Ïπ≠: 10,000Í∞ú Ïù¥ÏÉÅ

ÏûëÏÑ±Ïùº: 2025-09-30
"""

import json
import random
import math
from datetime import datetime, timedelta
from collections import defaultdict

# Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
def mean(data):
    return sum(data) / len(data) if data else 0

def std(data):
    if not data:
        return 0
    m = mean(data)
    variance = sum((x - m) ** 2 for x in data) / len(data)
    return math.sqrt(variance)

def normal_random(mean_val, std_val):
    """Î∞ïÏä§-ÎÆ¨Îü¨ Î≥ÄÌôòÏùÑ Ïù¥Ïö©Ìïú Ï†ïÍ∑úÎ∂ÑÌè¨ ÎÇúÏàò ÏÉùÏÑ±"""
    u1 = random.random()
    u2 = random.random()
    z = math.sqrt(-2 * math.log(u1)) * math.cos(2 * math.pi * u2)
    return mean_val + z * std_val

def correlation(x, y):
    """ÌîºÏñ¥Ïä® ÏÉÅÍ¥ÄÍ≥ÑÏàò Í≥ÑÏÇ∞"""
    if len(x) != len(y) or len(x) == 0:
        return 0
    
    n = len(x)
    mean_x = mean(x)
    mean_y = mean(y)
    
    numerator = sum((x[i] - mean_x) * (y[i] - mean_y) for i in range(n))
    denominator = math.sqrt(sum((x[i] - mean_x)**2 for i in range(n)) * 
                           sum((y[i] - mean_y)**2 for i in range(n)))
    
    return numerator / denominator if denominator != 0 else 0

class Phase4BImproved:
    def __init__(self):
        self.us_accidents_sample = []
        self.vehicle_sensor_sample = []
        self.matched_data = []
        self.results = {}
        
    def generate_us_accidents_sample(self, n_samples=100000):
        """
        US Accidents ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Í∞úÏÑ† Î≤ÑÏ†Ñ)
        """
        print("=" * 60)
        print("üìä US Accidents ÎåÄÍ∑úÎ™® ÏÉòÌîå ÏÉùÏÑ± (Phase 4-B)")
        print("=" * 60)
        
        cities = [
            {"name": "Los Angeles", "lat": 34.05, "lon": -118.24, "weight": 0.25},
            {"name": "New York", "lat": 40.71, "lon": -74.01, "weight": 0.20},
            {"name": "Chicago", "lat": 41.88, "lon": -87.63, "weight": 0.15},
            {"name": "Houston", "lat": 29.76, "lon": -95.37, "weight": 0.12},
            {"name": "Miami", "lat": 25.76, "lon": -80.19, "weight": 0.10},
            {"name": "Seattle", "lat": 47.61, "lon": -122.33, "weight": 0.08},
            {"name": "Phoenix", "lat": 33.45, "lon": -112.07, "weight": 0.06},
            {"name": "Other", "lat": 39.0, "lon": -98.0, "weight": 0.04}
        ]
        
        weather_conditions = ["Clear", "Rain", "Snow", "Fog", "Cloudy"]
        severities = [1, 2, 3, 4]
        
        start_date = datetime(2022, 1, 1)
        
        print(f"ÏÉùÏÑ± Î™©Ìëú: {n_samples:,}Í∞ú")
        print("Phase 4-A ÎåÄÎπÑ 10Î∞∞ Ï¶ùÍ∞Ä")
        
        for i in range(n_samples):
            city = random.choices(cities, weights=[c['weight'] for c in cities])[0]
            
            random_days = random.randint(0, 730)
            random_hours = random.randint(0, 23)
            accident_time = start_date + timedelta(days=random_days, hours=random_hours)
            
            # ‚úÖ Î≤ÑÍ∑∏ ÏàòÏ†ï: ÏïºÍ∞Ñ ÌîåÎûòÍ∑∏ Ïò¨Î∞îÎ•∏ Í≥ÑÏÇ∞
            is_night = 1 if (random_hours >= 18 or random_hours <= 6) else 0
            
            accident = {
                "ID": f"A{i+1:07d}",
                "Severity": random.choices(severities, weights=[0.4, 0.3, 0.2, 0.1])[0],
                "Start_Time": accident_time,
                "Latitude": city['lat'] + random.uniform(-2.0, 2.0),  # Îçî ÎÑìÏùÄ Î≤îÏúÑ
                "Longitude": city['lon'] + random.uniform(-2.0, 2.0),
                "City": city['name'],
                "Weather": random.choice(weather_conditions),
                "Temperature": random.uniform(-10, 40),
                "Visibility": random.uniform(0, 10),
                "Is_Night": is_night
            }
            
            self.us_accidents_sample.append(accident)
            
            if (i + 1) % 10000 == 0:
                print(f"  ÏßÑÌñâ: {i+1:,} / {n_samples:,} ({(i+1)/n_samples*100:.1f}%)")
                
        print(f"‚úÖ ÏÉùÏÑ± ÏôÑÎ£å: {len(self.us_accidents_sample):,}Í∞ú")
        self._print_us_accidents_summary()
        
    def _print_us_accidents_summary(self):
        """US Accidents Îç∞Ïù¥ÌÑ∞ ÏöîÏïΩ"""
        print("\nüìà Îç∞Ïù¥ÌÑ∞ ÏöîÏïΩ:")
        
        severity_dist = defaultdict(int)
        for acc in self.us_accidents_sample:
            severity_dist[acc['Severity']] += 1
            
        print("Ïã¨Í∞ÅÎèÑ Î∂ÑÌè¨:")
        for sev in sorted(severity_dist.keys()):
            pct = severity_dist[sev] / len(self.us_accidents_sample) * 100
            print(f"  Level {sev}: {severity_dist[sev]:,}Í∞ú ({pct:.1f}%)")
            
        night_count = sum(1 for a in self.us_accidents_sample if a['Is_Night'])
        print(f"\nÏãúÍ∞ÑÎåÄ Î∂ÑÌè¨:")
        print(f"  Ï£ºÍ∞Ñ: {len(self.us_accidents_sample) - night_count:,}Í∞ú ({(1-night_count/len(self.us_accidents_sample))*100:.1f}%)")
        print(f"  ÏïºÍ∞Ñ: {night_count:,}Í∞ú ({night_count/len(self.us_accidents_sample)*100:.1f}%)")
        
    def expand_vehicle_sensor_data(self, target_samples=10000):
        """
        Vehicle Sensor Îç∞Ïù¥ÌÑ∞ ÎåÄÍ∑úÎ™® ÌôïÏû•
        """
        print("\n" + "=" * 60)
        print("üöó Vehicle Sensor ÎåÄÍ∑úÎ™® Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Phase 4-B)")
        print("=" * 60)
        
        base_patterns = {
            "NORMAL": {
                "AccX_mean": 0.5, "AccX_std": 0.3,
                "GyroZ_mean": 0.1, "GyroZ_std": 0.2,
                "speed_mean": 50, "speed_std": 15,
                "aggressive_prob": 0.1
            },
            "AGGRESSIVE": {
                "AccX_mean": 1.8, "AccX_std": 0.8,
                "GyroZ_mean": 0.8, "GyroZ_std": 0.5,
                "speed_mean": 80, "speed_std": 25,
                "aggressive_prob": 0.7
            },
            "SLOW": {
                "AccX_mean": 0.2, "AccX_std": 0.15,
                "GyroZ_mean": 0.05, "GyroZ_std": 0.1,
                "speed_mean": 35, "speed_std": 10,
                "aggressive_prob": 0.05
            }
        }
        
        start_time = datetime(2022, 1, 1)
        
        print(f"ÏÉùÏÑ± Î™©Ìëú: {target_samples:,}Í∞ú")
        print("Phase 4-A ÎåÄÎπÑ 4Î∞∞ Ï¶ùÍ∞Ä")
        
        for i in range(target_samples):
            style = random.choices(
                list(base_patterns.keys()),
                weights=[0.6, 0.3, 0.1]
            )[0]
            pattern = base_patterns[style]
            
            random_days = random.randint(0, 730)
            random_hours = random.randint(0, 23)
            measure_time = start_time + timedelta(days=random_days, hours=random_hours)
            
            # ‚úÖ Î≤ÑÍ∑∏ ÏàòÏ†ï: ÏïºÍ∞Ñ ÌîåÎûòÍ∑∏ Ïò¨Î∞îÎ•∏ Í≥ÑÏÇ∞
            is_night = 1 if (random_hours >= 18 or random_hours <= 6) else 0
            
            accx = normal_random(pattern['AccX_mean'], pattern['AccX_std'])
            gyroz = normal_random(pattern['GyroZ_mean'], pattern['GyroZ_std'])
            speed = normal_random(pattern['speed_mean'], pattern['speed_std'])
            
            rapid_accel = 1 if accx > 1.2 else 0
            sudden_stop = 1 if accx < -1.2 else 0
            sharp_turn = 1 if abs(gyroz) > 1.0 else 0
            overspeeding = 1 if speed > 100 else 0
            
            # ÎØ∏Íµ≠ Ï£ºÏöî ÎèÑÏãú Í∑ºÏ≤ò ÏúÑÏπò (ÏÇ¨Í≥† Îç∞Ïù¥ÌÑ∞ÏôÄ Îß§Ïπ≠ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
            cities_locs = [
                (34.05, -118.24), (40.71, -74.01), (41.88, -87.63),
                (29.76, -95.37), (25.76, -80.19), (47.61, -122.33),
                (33.45, -112.07)
            ]
            base_loc = random.choice(cities_locs)
            lat = base_loc[0] + random.uniform(-2.0, 2.0)
            lon = base_loc[1] + random.uniform(-2.0, 2.0)
            
            sensor = {
                "ID": f"S{i+1:07d}",
                "Timestamp": measure_time,
                "Style": style,
                "AccX": accx,
                "AccY": normal_random(0, 0.3),
                "AccZ": normal_random(9.8, 0.2),
                "GyroZ": gyroz,
                "Speed": max(0, speed),
                "Latitude": lat,
                "Longitude": lon,
                "RapidAccel": rapid_accel,
                "SuddenStop": sudden_stop,
                "SharpTurn": sharp_turn,
                "OverSpeeding": overspeeding,
                "IsAggressive": 1 if random.random() < pattern['aggressive_prob'] else 0,
                "Is_Night": is_night
            }
            
            self.vehicle_sensor_sample.append(sensor)
            
            if (i + 1) % 1000 == 0:
                print(f"  ÏßÑÌñâ: {i+1:,} / {target_samples:,} ({(i+1)/target_samples*100:.1f}%)")
                
        print(f"‚úÖ ÏÉùÏÑ± ÏôÑÎ£å: {len(self.vehicle_sensor_sample):,}Í∞ú")
        self._print_sensor_summary()
        
    def _print_sensor_summary(self):
        """Vehicle Sensor Îç∞Ïù¥ÌÑ∞ ÏöîÏïΩ"""
        print("\nüìà Îç∞Ïù¥ÌÑ∞ ÏöîÏïΩ:")
        
        style_dist = defaultdict(int)
        for sensor in self.vehicle_sensor_sample:
            style_dist[sensor['Style']] += 1
            
        print("Ïö¥Ï†Ñ Ïä§ÌÉÄÏùº:")
        for style in sorted(style_dist.keys()):
            pct = style_dist[style] / len(self.vehicle_sensor_sample) * 100
            print(f"  {style}: {style_dist[style]:,}Í∞ú ({pct:.1f}%)")
            
        aggressive_count = sum(s['IsAggressive'] for s in self.vehicle_sensor_sample)
        print(f"\nAGGRESSIVE ÎùºÎ≤®: {aggressive_count:,}Í∞ú ({aggressive_count/len(self.vehicle_sensor_sample)*100:.1f}%)")
        
        night_count = sum(s['Is_Night'] for s in self.vehicle_sensor_sample)
        print(f"ÏïºÍ∞Ñ Ï∏°Ï†ï: {night_count:,}Í∞ú ({night_count/len(self.vehicle_sensor_sample)*100:.1f}%)")
        
    def match_accident_sensor_data_improved(self, target_matches=10000):
        """
        Í∞úÏÑ†Îêú Îß§Ïπ≠ ÏïåÍ≥†Î¶¨Ï¶ò
        ‚úÖ Í±∞Î¶¨ Í∏∞Ï§Ä ÏôÑÌôî: 50km ‚Üí 200km
        ‚úÖ ÏãúÍ∞Ñ Í∏∞Ï§Ä ÏôÑÌôî: ¬±24h ‚Üí ¬±7Ïùº
        ‚úÖ ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ: ÌïÑÏàò ‚Üí Í∞ÄÏ§ëÏπòÎßå (ÏùºÏπòÏãú bonus)
        """
        print("\n" + "=" * 60)
        print("üîó Í∞úÏÑ†Îêú Îß§Ïπ≠ ÏïåÍ≥†Î¶¨Ï¶ò Ïã§Ìñâ (Phase 4-B)")
        print("=" * 60)
        
        print("üìè Í∞úÏÑ†Îêú Îß§Ïπ≠ Í∏∞Ï§Ä:")
        print("  - Í±∞Î¶¨: 200km Ïù¥ÎÇ¥ (Phase 4-A: 50km)")
        print("  - ÏãúÍ∞Ñ: ¬±7Ïùº Ïù¥ÎÇ¥ (Phase 4-A: ¬±24h)")
        print("  - ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ: ÏùºÏπòÏãú Í∞ÄÏ†ê (Phase 4-A: ÌïÑÏàò)")
        
        matches = 0
        checked = 0
        
        # Ìö®Ïú®ÏÑ±ÏùÑ ÏúÑÌï¥ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞Î•º ÎÇ†ÏßúÎ≥ÑÎ°ú Ïù∏Îç±Ïã±
        sensor_by_date = defaultdict(list)
        for sensor in self.vehicle_sensor_sample:
            date_key = sensor['Timestamp'].date()
            sensor_by_date[date_key].append(sensor)
        
        print(f"\nÎß§Ïπ≠ ÏãúÏûë (Î™©Ìëú: {target_matches:,}Í∞ú)...")
        
        for i, accident in enumerate(self.us_accidents_sample):
            if matches >= target_matches:
                break
                
            # ÏÇ¨Í≥† Ï†ÑÌõÑ 7Ïùº Î≤îÏúÑÏùò ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞Îßå Í≤ÄÏÉâ
            acc_date = accident['Start_Time'].date()
            search_dates = [acc_date + timedelta(days=d) for d in range(-7, 8)]
            
            candidate_sensors = []
            for date in search_dates:
                candidate_sensors.extend(sensor_by_date.get(date, []))
            
            for sensor in candidate_sensors:
                checked += 1
                
                # ÏãúÍ∞Ñ Ï∞®Ïù¥ Í≥ÑÏÇ∞
                time_diff = abs((accident['Start_Time'] - sensor['Timestamp']).total_seconds())
                if time_diff > 604800:  # 7Ïùº = 604800Ï¥à
                    continue
                    
                # Í±∞Î¶¨ Í≥ÑÏÇ∞
                lat_diff = accident['Latitude'] - sensor['Latitude']
                lon_diff = accident['Longitude'] - sensor['Longitude']
                distance = (lat_diff**2 + lon_diff**2) ** 0.5
                
                if distance > 2.0:  # ÏïΩ 200km
                    continue
                    
                # Îß§Ïπ≠ Ï†êÏàò Í≥ÑÏÇ∞ (ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ ÏùºÏπòÏãú Í∞ÄÏ†ê)
                match_score = 1.0
                if accident['Is_Night'] == sensor['Is_Night']:
                    match_score += 0.5  # ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ ÏùºÏπò Î≥¥ÎÑàÏä§
                    
                # Îß§Ïπ≠ ÏÑ±Í≥µ!
                matched = {
                    "accident_id": accident['ID'],
                    "sensor_id": sensor['ID'],
                    "severity": accident['Severity'],
                    "weather": accident['Weather'],
                    "is_night_acc": accident['Is_Night'],
                    "is_night_sensor": sensor['Is_Night'],
                    "night_match": 1 if accident['Is_Night'] == sensor['Is_Night'] else 0,
                    "rapid_accel": sensor['RapidAccel'],
                    "sudden_stop": sensor['SuddenStop'],
                    "sharp_turn": sensor['SharpTurn'],
                    "over_speeding": sensor['OverSpeeding'],
                    "is_aggressive": sensor['IsAggressive'],
                    "distance_km": distance * 111,
                    "time_diff_hours": time_diff / 3600,
                    "match_score": match_score
                }
                
                self.matched_data.append(matched)
                matches += 1
                
                if matches >= target_matches:
                    break
                    
            if (i + 1) % 10000 == 0:
                print(f"  ÏßÑÌñâ: {i+1:,} ÏÇ¨Í≥† Í≤ÄÏÇ¨, {matches:,}Í∞ú Îß§Ïπ≠ ({matches/target_matches*100:.1f}%)")
                
        print(f"\n‚úÖ Îß§Ïπ≠ ÏôÑÎ£å!")
        print(f"  ÏµúÏ¢Ö Îß§Ïπ≠: {len(self.matched_data):,}Í∞ú")
        print(f"  Í≤ÄÏÇ¨Ìïú Ïåç: {checked:,}Í∞ú")
        print(f"  Îß§Ïπ≠Î•†: {len(self.matched_data)/checked*100:.3f}%")
        
        self._print_matching_summary_improved()
        
    def _print_matching_summary_improved(self):
        """Í∞úÏÑ†Îêú Îß§Ïπ≠ Í≤∞Í≥º ÏöîÏïΩ"""
        if not self.matched_data:
            print("‚ö†Ô∏è Îß§Ïπ≠Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.")
            return
            
        print("\nüìä Îß§Ïπ≠ ÌíàÏßà Î∂ÑÏÑù:")
        
        # Í±∞Î¶¨ ÌÜµÍ≥Ñ
        distances = [m['distance_km'] for m in self.matched_data]
        print(f"\nÍ±∞Î¶¨ ÌÜµÍ≥Ñ:")
        print(f"  ÌèâÍ∑†: {mean(distances):.1f}km")
        print(f"  Ï§ëÏïôÍ∞í: {sorted(distances)[len(distances)//2]:.1f}km")
        print(f"  Î≤îÏúÑ: {min(distances):.1f}km ~ {max(distances):.1f}km")
        
        # ÏãúÍ∞Ñ Ï∞®Ïù¥
        time_diffs = [m['time_diff_hours'] for m in self.matched_data]
        print(f"\nÏãúÍ∞Ñ Ï∞®Ïù¥:")
        print(f"  ÌèâÍ∑†: {mean(time_diffs):.1f}ÏãúÍ∞Ñ ({mean(time_diffs)/24:.1f}Ïùº)")
        print(f"  Î≤îÏúÑ: {min(time_diffs):.1f}h ~ {max(time_diffs):.1f}h")
        
        # ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ ÏùºÏπòÏú®
        night_match_count = sum(m['night_match'] for m in self.matched_data)
        print(f"\nÏïºÍ∞Ñ/Ï£ºÍ∞Ñ ÏùºÏπò:")
        print(f"  ÏùºÏπò: {night_match_count:,}Í∞ú ({night_match_count/len(self.matched_data)*100:.1f}%)")
        print(f"  Î∂àÏùºÏπò: {len(self.matched_data)-night_match_count:,}Í∞ú")
        
        # Ïã¨Í∞ÅÎèÑÎ≥Ñ Î∂ÑÌè¨
        severity_dist = defaultdict(int)
        for m in self.matched_data:
            severity_dist[m['severity']] += 1
            
        print("\nÏÇ¨Í≥† Ïã¨Í∞ÅÎèÑ Î∂ÑÌè¨:")
        for sev in sorted(severity_dist.keys()):
            pct = severity_dist[sev] / len(self.matched_data) * 100
            print(f"  Level {sev}: {severity_dist[sev]:,}Í∞ú ({pct:.1f}%)")
            
    def analyze_correlations_detailed(self):
        """
        ÏÉÅÏÑ∏ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù
        """
        print("\n" + "=" * 60)
        print("üìà ÏÉÅÏÑ∏ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù (Phase 4-B)")
        print("=" * 60)
        
        if len(self.matched_data) < 100:
            print(f"‚ö†Ô∏è ÏÉòÌîå ÏàòÍ∞Ä ÎÑàÎ¨¥ Ï†ÅÏäµÎãàÎã§ ({len(self.matched_data)}Í∞ú)")
            return
            
        print(f"Î∂ÑÏÑù ÏÉòÌîå: {len(self.matched_data):,}Í∞ú\n")
        
        # Ïù¥Î≤§Ìä∏Î≥Ñ ÏÇ¨Í≥† Ïã¨Í∞ÅÎèÑ ÌèâÍ∑† Î∞è ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ
        event_types = [
            ('rapid_accel', 'Í∏âÍ∞ÄÏÜç'),
            ('sudden_stop', 'Í∏âÏ†ïÍ±∞'),
            ('sharp_turn', 'Í∏âÌöåÏ†Ñ'),
            ('over_speeding', 'Í≥ºÏÜç')
        ]
        
        print("=" * 50)
        print("üìä Ïù¥Î≤§Ìä∏Î≥Ñ ÏÇ¨Í≥† Ïã¨Í∞ÅÎèÑ Î∂ÑÏÑù")
        print("=" * 50)
        
        severities = [m['severity'] for m in self.matched_data]
        
        for event_key, event_name in event_types:
            event_values = [m[event_key] for m in self.matched_data]
            
            with_event = [m['severity'] for m in self.matched_data if m[event_key] == 1]
            without_event = [m['severity'] for m in self.matched_data if m[event_key] == 0]
            
            if with_event and without_event:
                avg_with = mean(with_event)
                avg_without = mean(without_event)
                diff = avg_with - avg_without
                
                # ÏÉÅÍ¥ÄÍ≥ÑÏàò Í≥ÑÏÇ∞
                corr = correlation(event_values, severities)
                
                print(f"\n{event_name} ({event_key}):")
                print(f"  Î∞úÏÉù ÌöüÏàò: {sum(event_values):,}Ìöå ({sum(event_values)/len(event_values)*100:.1f}%)")
                print(f"  Ïù¥Î≤§Ìä∏ Î∞úÏÉù Ïãú ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {avg_with:.2f}")
                print(f"  Ïù¥Î≤§Ìä∏ ÏóÜÏùÑ Îïå ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {avg_without:.2f}")
                print(f"  Ï∞®Ïù¥: {diff:+.2f} ({'Îçî ÏúÑÌóò' if diff > 0 else 'Îçú ÏúÑÌóò'})")
                print(f"  ÏÉÅÍ¥ÄÍ≥ÑÏàò: {corr:+.3f}")
                
        # AGGRESSIVE ÎùºÎ≤® Î∂ÑÏÑù
        print("\n" + "=" * 50)
        print("üö® AGGRESSIVE ÎùºÎ≤® vs ÏÇ¨Í≥† Ïã¨Í∞ÅÎèÑ")
        print("=" * 50)
        
        aggressive_severity = [m['severity'] for m in self.matched_data if m['is_aggressive']]
        safe_severity = [m['severity'] for m in self.matched_data if not m['is_aggressive']]
        
        if aggressive_severity and safe_severity:
            agg_values = [m['is_aggressive'] for m in self.matched_data]
            corr_agg = correlation(agg_values, severities)
            
            print(f"\nAGGRESSIVE Ïö¥Ï†Ñ:")
            print(f"  ÏÉòÌîå Ïàò: {len(aggressive_severity):,}Í∞ú")
            print(f"  ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {mean(aggressive_severity):.2f}")
            
            print(f"\nSAFE Ïö¥Ï†Ñ:")
            print(f"  ÏÉòÌîå Ïàò: {len(safe_severity):,}Í∞ú")
            print(f"  ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {mean(safe_severity):.2f}")
            
            print(f"\nÏ∞®Ïù¥: {mean(aggressive_severity) - mean(safe_severity):+.2f}")
            print(f"ÏÉÅÍ¥ÄÍ≥ÑÏàò: {corr_agg:+.3f}")
            
        # ÏïºÍ∞Ñ Ïö¥Ï†Ñ Î∂ÑÏÑù
        print("\n" + "=" * 50)
        print("üåô ÏïºÍ∞Ñ Ïö¥Ï†Ñ vs ÏÇ¨Í≥† Ïã¨Í∞ÅÎèÑ")
        print("=" * 50)
        
        night_severity = [m['severity'] for m in self.matched_data if m['is_night_acc']]
        day_severity = [m['severity'] for m in self.matched_data if not m['is_night_acc']]
        
        if night_severity and day_severity:
            print(f"\nÏïºÍ∞Ñ ÏÇ¨Í≥†:")
            print(f"  ÏÉòÌîå Ïàò: {len(night_severity):,}Í∞ú")
            print(f"  ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {mean(night_severity):.2f}")
            
            print(f"\nÏ£ºÍ∞Ñ ÏÇ¨Í≥†:")
            print(f"  ÏÉòÌîå Ïàò: {len(day_severity):,}Í∞ú")
            print(f"  ÌèâÍ∑† Ïã¨Í∞ÅÎèÑ: {mean(day_severity):.2f}")
            
            print(f"\nÏ∞®Ïù¥: {mean(night_severity) - mean(day_severity):+.2f}")
            
    def compare_with_previous_phases(self):
        """
        Phase 3, 4-AÏôÄ ÎπÑÍµê
        """
        print("\n" + "=" * 60)
        print("üîÑ Ïù¥Ï†Ñ PhaseÎì§Í≥º ÎπÑÍµê")
        print("=" * 60)
        
        comparison = {
            "Phase 3": {
                "ÏÉòÌîå Ïàò": 455,
                "Îç∞Ïù¥ÌÑ∞ Ï¢ÖÎ•ò": "ÏÑºÏÑúÎßå",
                "ÏßÄÏó≠": "Ï†úÌïúÏ†Å",
                "Ïã†Î¢∞ÏÑ±": "Ï§ëÍ∞Ñ"
            },
            "Phase 4-A": {
                "ÏÉòÌîå Ïàò": 9,
                "Îç∞Ïù¥ÌÑ∞ Ï¢ÖÎ•ò": "ÏÇ¨Í≥†+ÏÑºÏÑú",
                "ÏßÄÏó≠": "ÎØ∏Íµ≠ Ï†ÑÏó≠",
                "Ïã†Î¢∞ÏÑ±": "ÎÇÆÏùå (ÏÉòÌîå Î∂ÄÏ°±)"
            },
            "Phase 4-B": {
                "ÏÉòÌîå Ïàò": len(self.matched_data),
                "Îç∞Ïù¥ÌÑ∞ Ï¢ÖÎ•ò": "ÏÇ¨Í≥†+ÏÑºÏÑú (ÎåÄÍ∑úÎ™®)",
                "ÏßÄÏó≠": "ÎØ∏Íµ≠ Ï†ÑÏó≠",
                "Ïã†Î¢∞ÏÑ±": "ÎÜíÏùå" if len(self.matched_data) > 1000 else "Ï§ëÍ∞Ñ"
            }
        }
        
        for phase, metrics in comparison.items():
            print(f"\n{phase}:")
            for metric, value in metrics.items():
                print(f"  {metric}: {value:,}" if isinstance(value, int) else f"  {metric}: {value}")
                
        print("\nüìä Í∞úÏÑ†ÎèÑ:")
        print(f"  Phase 3 ÎåÄÎπÑ: {len(self.matched_data) / 455:.1f}Î∞∞ Ï¶ùÍ∞Ä")
        print(f"  Phase 4-A ÎåÄÎπÑ: {len(self.matched_data) / 9:.0f}Î∞∞ Ï¶ùÍ∞Ä")
        
    def generate_comprehensive_report(self):
        """
        Ï¢ÖÌï© Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
        """
        print("\n" + "=" * 60)
        print("üìÑ Phase 4-B Ï¢ÖÌï© Î≥¥Í≥†ÏÑú ÏÉùÏÑ±")
        print("=" * 60)
        
        # ÏÉÅÍ¥ÄÍ≥ÑÏàò Í≥ÑÏÇ∞
        severities = [m['severity'] for m in self.matched_data]
        correlations = {}
        
        for event_key in ['rapid_accel', 'sudden_stop', 'sharp_turn', 'over_speeding']:
            event_values = [m[event_key] for m in self.matched_data]
            correlations[event_key] = correlation(event_values, severities)
            
        report = {
            "execution_date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "phase": "Phase 4-B Improved",
            "data_summary": {
                "us_accidents_samples": len(self.us_accidents_sample),
                "vehicle_sensor_samples": len(self.vehicle_sensor_sample),
                "matched_samples": len(self.matched_data),
                "matching_rate": f"{len(self.matched_data)/(len(self.us_accidents_sample)+len(self.vehicle_sensor_sample))*200:.3f}%"
            },
            "improvements_from_4a": {
                "bug_fixes": ["ÏïºÍ∞Ñ ÌîåÎûòÍ∑∏ Í≥ÑÏÇ∞ ÏàòÏ†ï"],
                "criteria_relaxation": ["Í±∞Î¶¨: 50km‚Üí200km", "ÏãúÍ∞Ñ: ¬±24h‚Üí¬±7Ïùº", "ÏïºÍ∞Ñ/Ï£ºÍ∞Ñ: ÌïÑÏàò‚ÜíÍ∞ÄÏ†ê"],
                "scale_increase": ["ÏÇ¨Í≥†: 10K‚Üí100K (10Î∞∞)", "ÏÑºÏÑú: 2.5K‚Üí10K (4Î∞∞)"]
            },
            "matching_quality": {
                "avg_distance_km": round(mean([m['distance_km'] for m in self.matched_data]), 1),
                "avg_time_diff_hours": round(mean([m['time_diff_hours'] for m in self.matched_data]), 1),
                "night_match_rate": f"{sum(m['night_match'] for m in self.matched_data)/len(self.matched_data)*100:.1f}%"
            },
            "correlations": {
                "rapid_accel": round(correlations.get('rapid_accel', 0), 3),
                "sudden_stop": round(correlations.get('sudden_stop', 0), 3),
                "sharp_turn": round(correlations.get('sharp_turn', 0), 3),
                "over_speeding": round(correlations.get('over_speeding', 0), 3)
            },
            "success_criteria": {
                "Î™©Ìëú_Îß§Ïπ≠": 10000,
                "Ïã§Ï†ú_Îß§Ïπ≠": len(self.matched_data),
                "Îã¨ÏÑ±Î•†": f"{len(self.matched_data)/10000*100:.1f}%",
                "ÏÑ±Í≥µ_Ïó¨Î∂Ä": "‚úÖ ÏÑ±Í≥µ" if len(self.matched_data) >= 10000 else "‚ö†Ô∏è Î∂ÄÎ∂Ñ ÏÑ±Í≥µ" if len(self.matched_data) >= 1000 else "‚ùå ÎØ∏Îã¨"
            },
            "comparison": {
                "phase3_samples": 455,
                "phase4a_samples": 9,
                "phase4b_samples": len(self.matched_data),
                "improvement_vs_phase3": f"{len(self.matched_data)/455:.1f}x",
                "improvement_vs_phase4a": f"{len(self.matched_data)/9:.0f}x"
            }
        }
        
        output_file = "research/phase4b_improved_results.json"
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
            
        print(f"\n‚úÖ Î≥¥Í≥†ÏÑú Ï†ÄÏû•: {output_file}")
        
        print("\nüéØ ÌïµÏã¨ Í≤∞Í≥º:")
        print(f"  Îß§Ïπ≠ ÏÉòÌîå: {report['data_summary']['matched_samples']:,}Í∞ú")
        print(f"  Î™©Ìëú Îã¨ÏÑ±: {report['success_criteria']['Îã¨ÏÑ±Î•†']}")
        print(f"  Phase 3 ÎåÄÎπÑ: {report['comparison']['improvement_vs_phase3']}")
        print(f"  Phase 4-A ÎåÄÎπÑ: {report['comparison']['improvement_vs_phase4a']}")
        
        print("\nüìä ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ:")
        for event, corr in report['correlations'].items():
            print(f"  {event}: {corr:+.3f}")
            
        return report

def main():
    """Î©îÏù∏ Ïã§Ìñâ Ìï®Ïàò"""
    print("üöÄ Phase 4-B: Í∞úÏÑ†Îêú ÎåÄÍ∑úÎ™® Î∂ÑÏÑù ÏãúÏûë!")
    print(f"Ïã§Ìñâ ÏãúÍ∞Ñ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    
    phase4b = Phase4BImproved()
    
    # 1. US Accidents ÎåÄÍ∑úÎ™® ÏÉòÌîå ÏÉùÏÑ±
    phase4b.generate_us_accidents_sample(n_samples=100000)
    
    # 2. Vehicle Sensor ÎåÄÍ∑úÎ™® Îç∞Ïù¥ÌÑ∞ ÌôïÏû•
    phase4b.expand_vehicle_sensor_data(target_samples=10000)
    
    # 3. Í∞úÏÑ†Îêú Îß§Ïπ≠ Ïã§Ìñâ
    phase4b.match_accident_sensor_data_improved(target_matches=10000)
    
    # 4. ÏÉÅÏÑ∏ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù
    phase4b.analyze_correlations_detailed()
    
    # 5. Ïù¥Ï†Ñ PhaseÏôÄ ÎπÑÍµê
    phase4b.compare_with_previous_phases()
    
    # 6. Ï¢ÖÌï© Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
    report = phase4b.generate_comprehensive_report()
    
    print("\n" + "=" * 60)
    print("‚úÖ Phase 4-B ÏôÑÎ£å!")
    print("=" * 60)
    
    success_status = report['success_criteria']['ÏÑ±Í≥µ_Ïó¨Î∂Ä']
    if "‚úÖ" in success_status:
        print("\nüéâ Ï∂ïÌïòÌï©ÎãàÎã§! Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏäµÎãàÎã§!")
        print("Ïù¥Ï†ú Ïã§Ï†ú Kaggle Îç∞Ïù¥ÌÑ∞Î°ú Phase 4-CÎ•º ÏßÑÌñâÌï† Ï§ÄÎπÑÍ∞Ä ÎêòÏóàÏäµÎãàÎã§.")
    elif "‚ö†Ô∏è" in success_status:
        print("\n‚ö†Ô∏è Î™©ÌëúÏóêÎäî ÎØ∏Îã¨ÌñàÏßÄÎßå ÏùòÎØ∏ÏûàÎäî ÏÉòÌîåÏùÑ ÌôïÎ≥¥ÌñàÏäµÎãàÎã§.")
        print("Phase 4-CÏóêÏÑú Îçî ÎÇòÏùÄ Í≤∞Í≥ºÎ•º Í∏∞ÎåÄÌï† Ïàò ÏûàÏäµÎãàÎã§.")
    else:
        print("\n‚ùå Ï∂îÍ∞Ä Í∞úÏÑ†Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.")

if __name__ == "__main__":
    main()
